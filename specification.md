# UploaderApp 改修仕様書 (specification.md)
作成日: 2025-11-22 01:40:17

## 概要
UploaderApp はローカルの画像ファイルをサーバー (FTPS) にアップロードする GUI ツールです。
本改修は差分チェックの高速化、プログレス表示の安定化、そして安全に ChatGPT にコード生成を依頼できるためのプロンプトとドキュメント整備を目的とします。

---

## 目的
1. `common/img` 配下にあるアップロード対象3ディレクトリだけを対象に、**必要最小限の FTPS 通信回数**で差分チェックを行う。
2. Tkinter GUI のメインスレッドをブロックしない形で差分チェックとアップロード処理を実行し、**インジケーター／割合型プログレスバー**を安定して表示する。
3. ChatGPT に渡す「再現性のあるプロンプト」を作成し、将来的なコード生成で既存機能を壊さないようにする。
4. 開発者向けの README を整備する。

---

## 前提（与えられた情報）
- GUI: Tkinter
- 通信方式: FTPS（ftplib.FTP_TLS を想定）
- サーバー一覧取得: `ftps.nlst()` を使用（ディレクトリ単位で取得）
- 既存判定: ローカルファイル名（拡張子含む）とサーバーから取得した nlst のファイル名（basename）を比較して判定
- 差分対象: 画像のみ（png, jpg, jpeg, gif, webp, bmp）
- settings.json 例:
```json
{
  "host": "xxxx",
  "port": 21,
  "user": "xxxx",
  "password": "xxx",
  "remote_base": "/common",
  "local_base": "common"
}
```
- `common/img` 直下にアップロード対象ディレクトリが3つ存在する（それぞれ画像以外のファイルは含まない想定）

---

## 要件（改修仕様）

### 高速差分チェック（必須）
- ローカル側は `local_base/img` の直下 3 ディレクトリを確認する（再帰は不要と仮定）。
- サーバー側へは「ローカルに存在するディレクトリ」単位で `nlst()` を呼び出す。  
  例: ローカル `common/img/dirA` がある場合、サーバー `remote_base/img/dirA` に対して `nlst()` を 1 回だけ実行する。
- サーバー問い合わせ回数 = ローカルに存在するディレクトリ数（最大 3 回）。
- `nlst()` の結果は `basename`（ファイル名＋拡張子）で扱い、ローカルの `Path.name` と比較して既存/新規を判定する。
- 比較はファイル名の等価性のみ（サイズ/更新日時は比較しない）。

### FTPS の実装注意点
- `ftplib.FTP_TLS` を用いる。接続時は以下を順に実行する:
  1. `ftp = FTP_TLS(host, user, passwd, timeout=...)`
  2. `ftp.prot_p()` を呼んでデータ接続も TLS 化
  3. `ftp.cwd(remote_path)` → `ftp.nlst()`（必要ディレクトリ単位）
- ネットワーク例外（タイムアウト、接続拒否、認証失敗など）は捕まえて GUI にエラーメッセージを表示すること。

### Tkinter とスレッド（UI 安定性）
- Tkinter はメインスレッドでのみ UI 更新を許す。差分チェックおよびアップロード処理は **ワーカースレッド**で実行する。
- スレッド間の通信は `queue.Queue`（スレッドセーフ）を使う。ワーカーは進捗/完了/ログをキューへ入れ、メインスレッドは `root.after(XXX, poll_queue)` で定期的にキューを取り出し UI を更新する。
- 進捗の種類:
  - チェック開始 / チェック完了（ディレクトリ単位）
  - 個別ファイルのアップロード開始 / 成功 / 失敗
  - 総計（チェック済み数、アップロード対象数、アップロード成功数/失敗数）
- プログレスバーは **インジケーター型（処理中アニメーション）** をチェック時に表示。アップロード時は可能であれば割合型に切り替え可能（処理上の難易度が低ければ）。

### プログレス表示（GUI）
- チェック処理: インジケーター（止まらないアニメーション）で「処理中」であることを示す。
- アップロード処理: ファイル総数が分かるため割合型プログレスバー (0-100%) を表示可能にする（オプション）。ただし実装の影響を最小にするため、まずはアップロード中もインジケーターで良しとすること。
- メイン GUI コンソールには以下を表示:
  - チェックしたファイル総数
  - アップロード対象ファイル数（チェック済みで選択されたもの）
  - アップロード成功数 / 失敗数
  - 最終ステータスメッセージ（例: "完了: 10 件成功, 2 件失敗"）

### ファイル選択 UI の既定状態
- 差分チェック結果に基づき、既存ファイルはチェックボックスを「未チェック」にし、ファイル名に "(既存)" のような注記を付与する。新規ファイルはデフォルトでチェック済みにする。

### ログと例外
- `logs/` フォルダへ運用ログを出力する（ローテーションは任意）。
- 重大な例外は GUI にエラーダイアログを出し、ログにスタックトレースを残す。
- FTPS の接続ログはデバッグレベルで出力可能にする（設定で切替）。

---

## API（内部関数・クラス設計案）
- `class FTPSClient`（img_uploader.py）
  - `connect()`, `disconnect()`, `list_dir(remote_path)`, `upload_file(local_path, remote_path)`, `ensure_dir(remote_path)`
  - 例外は専用例外にラップして上位へ伝える

- `class DiffChecker`（img_uploader.py）
  - `get_local_dirs()` → list of Path
  - `get_local_files(dir)` → list of Path (画像のみ)
  - `get_remote_filelist_for_local_dirs(local_dirs)` → dict(local_dir_name -> set(remote_basename))
  - `compute_diff()` → returns list of FileDiff objects (name, path, is_existing)

- `class UploaderWorker(Thread)`（gui.py / img_uploader.py）
  - 差分チェックとアップロードを実行し、`queue.Queue` にイベントを出す

- GUI 側（gui.py）
  - `MainWindow` : Tkinter フレーム構成（ファイルリスト、チェックボックス、コンソール、プログレス領域）
  - `start_check()` ボタンがワーカーを起動、キューをポーリングして UI 更新

---

## テストケース（必須）
1. 3 ディレクトリに画像ファイルが存在する正常系
2. サーバーに対象ディレクトリが存在しないケース（サーバー側ディレクトリ自動作成の処理確認）
3. ネットワーク切断（認証失敗、タイムアウト）時に GUI が適切にエラーを表示する
4. 既存ファイルがある場合、チェックが外れ、ファイル名に "(既存)" が付く
5. アップロード中に GUI がフリーズしない

---

## マイグレーション手順（実装順）
1. `FTPSClient` クラスを作成 / ユニットテスト
2. `DiffChecker` を作成し、ローカルディレクトリ単位で `FTPSClient.list_dir` を呼ぶ実装に差し替え
3. GUI のワーカースレッド + キュー実装（ダミーワーカーで UI がフリーズしないことを確認）
4. プログレス表示の実装（インジケーター）
5. アップロード機能の追加（割合型をサポートするならここで）
6. 結合テスト・運用テスト

---

## 運用上の注意
- サーバー側のパス区切りは OS により異なる場合があるが、FTPS での path はサーバー側の表記に従うこと。`remote_base` の先頭/末尾のスラッシュ取り扱いは厳密に統一する。
- settings.json のパスは Git 管理下に置かない（秘密情報は別ファイルまたは環境変数で上書き可能にすることを推奨）。
- 大量ファイルを扱う将来を見越して、API 呼び出し回数削減を常に優先する。

---

## 付録：推奨ライブラリ / 環境
- Python 3.8+
- 標準: ftplib（FTP_TLS）, threading, queue, pathlib, json, logging
- GUI: Tkinter（標準ライブラリ）
- 画像プレビューが必要なら Pillow（PIL）を追加
